from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
from models import Conflict, Employee
from database import db
import os
from openai import OpenAI

def get_openai_client():
    return OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

bp_conflict = Blueprint("conflict", __name__)

@bp_conflict.route("/api/conflict/resolve", methods=["POST"])
def resolve_conflict():
    data = request.json
    context = data.get("context")
    participants = data.get("participants")
    attempts = data.get("attempts")
    goal = data.get("goal")

    if not all([context, participants, attempts, goal]):
        return jsonify({"error": "Missing input data"}), 400

    client = get_openai_client()

    prompt = f"""
Ты Agile-коуч, фасилитатор конфликтов. На основе следующих данных определи DISC-профили участников, и предложи стратегию разрешения конфликта по наиболее подходящей модели из списка:  Конструктивная конфронтация как основной или Метод "вин-вин" (выиграл-выиграл),Коучинговый подход, Медиация, Pine, Ненасильственное общение (ННО) по Маршаллу Розенбергу или лбые другие которые ты посчитаешь наиболее правильными но не оборачивай в markdown ```html:
Вот матераил что может помочь с ответом на запрос
Работа с личностями типа D: решайте конфликты напрямую
Личности типа D решительны, напористы и нацелены на результат. Хотя их сильная воля может пугать, особенно людей, не склонных к конфликтам, они ценят прямоту. При решении разногласий с личностью типа D не бойтесь быть прямолинейными. Они предпочитают решать конфликты напрямую, быстро их решать и двигаться вперед. Решая проблемы открыто и без колебаний, вы заслужите их уважение и, скорее всего, сможете эффективно достичь решения.

Совет: будьте настойчивы, уважительны и нацелены на решение. Избегайте хождения вокруг да около — переходите к сути.

2. Управление конфликтами с личностями типа «Я»: сохраняйте позитивный настрой
Личности типа I полны энтузиазма, общительны и процветают в позитивном взаимодействии. Однако они чувствительны к отвержению или негативу. При решении конфликта с личностью типа I важно поддерживать легкий и оптимистичный разговор. Начните обсуждение с комплимента или признания их сильных сторон. Дружелюбный тон обеспечит их вовлеченность и восприимчивость к обратной связи, в то время как резкий подход может привести к отстранению.

Совет: Подходите с позитивом и теплотой. Сбалансируйте конструктивную обратную связь с поощрением.

3. Разрешение конфликта с типами личности S: поиск точек соприкосновения
Личности типа S ценят гармонию, стабильность и сотрудничество. Они склонны избегать конфронтации и могут соглашаться на компромиссы, которые они на самом деле не поддерживают, чтобы сохранить мир. При решении конфликта с личностью типа S крайне важно подчеркнуть сотрудничество и взаимопонимание. Сосредоточьтесь на общих чертах, прежде чем углубляться в различия. Предложение решения, при котором обе стороны вносят коррективы, даст лучшие результаты, чем настойчивое требование радикальных изменений.

Совет: Подчеркните партнерство и сотрудничество. Представьте сбалансированный компромисс, чтобы способствовать сотрудничеству.

4. Разрешение конфликта с личностями типа C: сосредоточьтесь на фактах, а не на критике
Личности типа C аналитичны, ориентированы на детали и стремятся к точности. Поскольку они тратят так много времени на то, чтобы их работа была безупречной, они склонны воспринимать критику лично. При решении конфликтов с личностью типа C сосредоточьтесь на проблеме, а не на выявлении недостатков. Сформулируйте проблему с точки зрения объективных фактов или внешних факторов, которые они могли не учесть. Такой подход позволяет им рассматривать ситуацию более логично, не чувствуя себя лично атакованными.

Совет: будьте ясны, основывайтесь на фактах и ​​избегайте личной критики. Признайте их тяжелую работу, представляя любые упущенные переменные. 

Конструктивная конфронтация: 1. Подготовка
algoritm-konstruktivnoj-konfrontacii-002

1) Определение проблемы
Итак, у нас имеется некоторая проблема или задача, которую необходимо решить со своим сотрудником, руководителем или заказчиком. Прежде всего необходимо точно определить суть проблемы. Иногда, это не так просто, как может показаться. Рассмотрим 2 типичных примера:

Пример 1:
Сотрудник все время сидит в социальной сети. В чем здесь проблема? В том, что он занимается посторонними вещами? Нет. Пусть сидит, если ему нравится. Проблем в том, что он не выполняет поставленные на него задачи. Вот это уже проблема.

Пример 2:
Вы владелец небольшой компании, занимающейся автоматизацией бизнес-процессов. Проблема — про вашу компанию мало что известно как среди потенциальных клиентов, так и среди профильных специалистов.

2) Поставить цель
Необходимо понять точную цель, которая должна быть достигнута.

Пример 1:
Закрыть доступ к социальным сетям? Нет. Цель — чтобы работа делалась во время.

Пример 2:
Один из ваших сотрудников должен выступить на профильной конференции с докладом.

3) Подготовить факты
Вместо своих личных оценочных суждений подготовить факты, с которыми трудно (или совсем невозможно) спорить. К суждению, а не факту, всегда можно задать вопрос «В чем это выражается?». Для факта этот вопрос звучит глупо.

Пример 1:
«Ты стал работать хуже.» — не факт. В чем это выражается? «Вот график. В последнее время ты зарываешь меньше часов разработки, чем раньше.» — факт.

Пример 2:
«О нас никто не знает.» — не факт. В чем это выражается? «За прошлый месяц мы получили всего 4 отклика соискателей на нашу вакансию.» — факт.

4) Запланировать подход
Прежде чем идти к человеку, необходимо понять, какие аргументы вы будете предъявлять и на что следует обратить внимание. Перед подбором аргументов, стоит также подумать, что движет этим человеком, какие у него мотивы, какие доводы будут наиболее эффективны. Для этого можно воспользоваться такими инструментами как:

Модель индивидуальных различий DISC: определяем тип личности по DISC, в зависимости от типа, подбираем необходимые аргументы.
Типология руководителей по И. Адизесу (модель PAEI): если вы собираетесь идти к своему руководителю, стоит понять, какой тип руководителя перед вами, какие ваши доводы он услышит с большей вероятностью.
 

Пример 1:
Сотрудник «сине-зеленый» по DISC, в этом случае, подойдут аргументы: «Посмотри на график, ты стал закрывать меньше часов разработки», «Твой показатель упал, а на тебя равняются другие», «Что случилось, давай разберем проблему вместе» и т. д.

Пример 2:
Сотрудник ярко-выраженная «желтая» личность по DISC. Для него подойдут такие доводы как: «Про тебя все узнают!», «У тебя появится много знакомых», «Твой авторитет в компании сильно вырастет» и т. д. 

Только точно определив цель и заранее подобрав аргументы, можно переходить к следующему шагу.

2. Проблема
algoritm-konstruktivnoj-konfrontacii-003

1) Озвучить проблему
Итак, проблема известна, вы встречаетесь с человеком, с которым эту проблему необходимо решить и озвучиваете ее. Не спешите сразу выплескивать все. Ведь все люди разные, и вы не можете знать, что у него в голове и под каким углом ему видится ситуация. Возьмите паузу, посмотрите как человек поведет себя, что сделает дальше. Пауза — это очень мощный прием.

Пример 1:
— Твои показатели упали в последнее время. Поделись, что случилось?

Пример 2:
— Хотел посоветоваться с тобой. О нас мало кто знает. Как ты думаешь, как бы нам раскрутить нашу организацию, сделать ее более известной?

2) Послушать точку зрения другой стороны
Это очень важный шаг! Может случиться так, что человек вообще не видит проблемы в данной ситуации, тогда вам пригодятся заранее подготовленные аргументы. А может быть, человек сам давно об этом думал, и лишний раз убеждать его нет никакого смысла.

Пример 1:
— Ничего не случилось вроде… Работаю как работаю…

Пример 2:
— Да, действительно, это важно. Я тоже думал об этом.

3) Получить согласие по проблеме
Это ключевой момент в алгоритме. Вы обязательно должны получить от человека согласие, что да, проблема имеет место быть! Если этого не сделать, если человек действительно сам не осознает в чем проблема или задача и почему ее необходимо решать, все дальнейшие шаги будут абсолютно бессмысленны. Может так случиться, что получить согласия по проблеме не удастся, несмотря на все ваши доводы и факты, в этом случае вы выходите из обсуждения со словами «Я, похоже, не могу донести проблему, давай поговорим позже». В этом нет ничего страшного. Подумайте и вернитесь к разговору чуть позже, с новыми фактами и аргументами. Может быть, и собеседник дозреет.

Пример 1:
— Да, правда, ситуация какая-то дурацкая…

Пример 2:
— Надо что-нибудь сделать в этом направлении!

Итак, подтверждение по проблеме получено, идем дальше.

3. Решение
algoritm-konstruktivnoj-konfrontacii-004

1) Попросить предложить решение
Когда вы донесли до человека суть проблемы, и он подтвердил, что действительно что-то необходимо изменить, велик соблазн сразу же выложить то решение, которое придумали вы. Так можно поступить, если вы беседуете со своим руководителем или заказчиком. В этом случае вы не создаете ему лишних проблем, а приходите сразу с конкретными предложениями. Если же вы решаете проблему со своим подчиненным, намного выгоднее сначала выслушать его предложения. Быть может он предложит лучший, или как раз тот самый вариант, который подготовили и вы. Но в этому случае, сотрудник примется реализовывать его с намного большим энтузиазмом, ведь это ЕГО план и он должен всем доказать, что он верен!

Пример 1:
— Ну я постараюсь более внимательно относиться к своим показателям. 

Пример 2: 
— А давай начнем вести корпоративный блог! Можно написать несколько профильных статей или что-то в этом роде. 

2) Рассмотреть варианты решения и выбрать один
Если же предложенный способ, по каким-то причинам вас не устраивает, не спешите критиковать его, лучше всего начать задавать наводящие вопросы. Утверждения включают в человеке желание поспорить. А что у человека включает мозг? Правильно, вопросы. Просто отвечая на вопросы, человек сам придет к выводу, что его решение не оптимально. И опять же, это будет уже его мнение, он будет чувствовать за него ответственность! Таким способом следует задавать вопросы до тех пор, пока сотрудник САМ не выработает такой стратегии решения задачи, которая удовлетворит и вас.

Пример 1:
— Просто задачи в последнее время какие-то скучные… 
— Без проблем! Скоро как-раз начнется новый проект. Хочешь поучаствовать?

Пример 2: 
— Еще можно записать обучающие видео…
— Отлично! Надо выбрать соответствующую площадку. Вот этот сайт сейчас очень популярен.
— Да, я сам его постоянно читаю. У них, кстати, скоро будет конференция, может выступить там?
— Хорошая идея! Ты смог бы это сделать?

3) Зафиксировать договоренность
Итак, проблема понятна, решение найдено, осталось только понять, кто и когда будет ее решать. В этом случае хорошо действует правило трех W: Who? What? When? (Кто? Что? Когда?). Вы, как человек, который ставит задачу, точно должны определить кто, что и в какие сроки должен сделать. Также необходимо убедиться, что все исполнители тоже точно это поняли.

Пример 1:
— Договорились, подтягивай свои показатели. Если с ними все будет ОК, я смогу убедить начальство перевести тебя на этот новый проект, который начнется осенью. Давай назначим следующую встречу на 1-ое сентября.

Пример 2: 
— Так, конференция через 2 месяца. Давай ты подумаешь о теме доклада. Я освобожу тебя от части задач, чтобы у тебя было время на подготовку. Встретимся в пятницу, посмотрим твои наработки.

Все задачи поставлены, сроки обговорены, далее необходим контроль.

4. Контроль
algoritm-konstruktivnoj-konfrontacii-005

1) Установить дату, чтобы обсудить прогресс
Как говаривал бывший генеральный директор IBM Лу Герстнер: «People do not do what you expect. They do what you inspect.» («Люди не делают то, что вы ожидаете. Они делают то, что вы проверяете.»). Поэтому очень важно назначить реперные точки — даты когда вы будете контролировать процесс решения задачи и объяснить что вы будете проверять. Например, если задача должна быть решена через месяц, то есть смысл раз в неделю-две интересоваться прогрессом выполнения. В этом случае вы сможете избежать ситуации, когда все будет делаться в последний момент.

Пример 1:
Сразу назначить в своем календаре и в календаре сотрудника встречу на 1-ое сентября, чтобы обговорить показатели.

Пример 2:
Зарегистрироваться на конференции. Назначить 3 встречи с интервалом в неделю: обсуждение темы, просмотр презентации и материалов, тестовый прогон выступления.

2) Проверить, достигнута ли цель?
Итак, вот долгожданный момент. Задача выполнена. Необходимо убедиться, что сделано именно то, что требовалось и в полном объеме.

Пример 1:
Сотрудник улучшил свои показатели. Время, проводимое в социальных сетях сильно сократилось.

Пример 2:
Выступление на конференции завершилось успешно. Посещаемость корпоративного сайта выросла. 

3) Проверить, что процесс работает
То, что поставленная задача выполнена, еще не означает, что изначальная проблема решена полностью. Может быть так, что в самом начале была не правильно определена цель, и проблема осталась.

Если, несмотря на все действия, цель не достигнута и проблема все равно не решена, необходимо тщательным образом проанализировать ситуацию и, как это не печально, вернуться к самому началу данного алгоритма.

Если же цель достигнута, то можно вздохнуть спокойно. Ура! Но и это не все. Обязательно необходимо похвалить (премировать, искренне признать заслуги) всех участников процесса. Это очень важно! В этом случае, люди с большим желанием возьмутся за следующую поставленную вами задачу.

Пример 1:
Похвалить сотрудника за хороший результат. Перевести его на новый проект.

Пример 2:
Публично поздравить сотрудника с успешным выступлением. Выложить видео на корпоративный сайт. Предложить продолжить выступать на конференциях и дальше.

Контекст конфликта:
{context}

Участники конфликта (эмоции, поведение, реакции):
{participants}

Что уже предпринималось:
{attempts}

Цель: {goal}

Структурируй ответ в HTML:
- Определи DISC профили
- Дай советы мне по взаимодействию со второй стороной конфликта
- Важно чтобы мне как тому кто обратился к тебе как коучу за помощью стало понятно что мне делать, чтобы решить этот конфликт, отстояв свою точку зрения и цели
- Предложи как с помощью конструктивного конфликта донести до второй стороны некоректность действия, предложи вариант даилога с этим человеком
"""

    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "Ты профессиональный фасилитатор Agile-команд."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
            max_tokens=4950
        )

        ai_response = response.choices[0].message.content

        # Сохраняем в БД
        conflict = Conflict(
            context=context,
            participants=participants,
            attempts=attempts,
            goal=goal,
            ai_response=ai_response
        )
        db.session.add(conflict)
        db.session.commit()

        return jsonify({"response": ai_response})

    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({"error": str(e)}), 500
@bp_conflict.route("/conflicts", methods=["POST"])
@jwt_required()
def create_conflict():
    data = request.json
    user_id = get_jwt_identity()

    try:
        conflict = Conflict(
            user_id=user_id,
            context=data["context"],
            participants=data["participants"],
            attempts=data["attempts"],
            goal=data["goal"],
            status=data.get("status", "активен"),
            employee_1_id=data.get("employee_1_id"),
            employee_2_id=data.get("employee_2_id")
        )
        db.session.add(conflict)
        db.session.commit()

        # Генерация анализа через OpenAI
        prompt = f"""
        Ты Agile-коуч, фасилитатор конфликтов. На основе следующих данных определи DISC-профили участников, и предложи стратегию разрешения конфликта по наиболее подходящей модели из списка:  Метод Конструктивная конфронтация как основной или "вин-вин" (выиграл-выиграл),Коучинговый подход, Медиация, Pine, Ненасильственное общение (ННО) по Маршаллу Розенбергу или лбые другие которые ты посчитаешь наиболее правильными но не оборачивай в markdown ```html:
Вот матераил что может помочь с ответом на запрос
Работа с личностями типа D: решайте конфликты напрямую
Личности типа D решительны, напористы и нацелены на результат. Хотя их сильная воля может пугать, особенно людей, не склонных к конфликтам, они ценят прямоту. При решении разногласий с личностью типа D не бойтесь быть прямолинейными. Они предпочитают решать конфликты напрямую, быстро их решать и двигаться вперед. Решая проблемы открыто и без колебаний, вы заслужите их уважение и, скорее всего, сможете эффективно достичь решения.

Совет: будьте настойчивы, уважительны и нацелены на решение. Избегайте хождения вокруг да около — переходите к сути.

2. Управление конфликтами с личностями типа «Я»: сохраняйте позитивный настрой
Личности типа I полны энтузиазма, общительны и процветают в позитивном взаимодействии. Однако они чувствительны к отвержению или негативу. При решении конфликта с личностью типа I важно поддерживать легкий и оптимистичный разговор. Начните обсуждение с комплимента или признания их сильных сторон. Дружелюбный тон обеспечит их вовлеченность и восприимчивость к обратной связи, в то время как резкий подход может привести к отстранению.

Совет: Подходите с позитивом и теплотой. Сбалансируйте конструктивную обратную связь с поощрением.

3. Разрешение конфликта с типами личности S: поиск точек соприкосновения
Личности типа S ценят гармонию, стабильность и сотрудничество. Они склонны избегать конфронтации и могут соглашаться на компромиссы, которые они на самом деле не поддерживают, чтобы сохранить мир. При решении конфликта с личностью типа S крайне важно подчеркнуть сотрудничество и взаимопонимание. Сосредоточьтесь на общих чертах, прежде чем углубляться в различия. Предложение решения, при котором обе стороны вносят коррективы, даст лучшие результаты, чем настойчивое требование радикальных изменений.

Совет: Подчеркните партнерство и сотрудничество. Представьте сбалансированный компромисс, чтобы способствовать сотрудничеству.

4. Разрешение конфликта с личностями типа C: сосредоточьтесь на фактах, а не на критике
Личности типа C аналитичны, ориентированы на детали и стремятся к точности. Поскольку они тратят так много времени на то, чтобы их работа была безупречной, они склонны воспринимать критику лично. При решении конфликтов с личностью типа C сосредоточьтесь на проблеме, а не на выявлении недостатков. Сформулируйте проблему с точки зрения объективных фактов или внешних факторов, которые они могли не учесть. Такой подход позволяет им рассматривать ситуацию более логично, не чувствуя себя лично атакованными.

Совет: будьте ясны, основывайтесь на фактах и ​​избегайте личной критики. Признайте их тяжелую работу, представляя любые упущенные переменные. 
Ту часть что находится ниже, можешь использовать если посчитаешь релевантным для ситуации в ином случае дай несолько других вариантов что можно сделать:

Конструктивная конфронтация: 1. Подготовка
algoritm-konstruktivnoj-konfrontacii-002

1) Определение проблемы
Итак, у нас имеется некоторая проблема или задача, которую необходимо решить со своим сотрудником, руководителем или заказчиком. Прежде всего необходимо точно определить суть проблемы. Иногда, это не так просто, как может показаться. Рассмотрим 2 типичных примера:

Пример 1:
Сотрудник все время сидит в социальной сети. В чем здесь проблема? В том, что он занимается посторонними вещами? Нет. Пусть сидит, если ему нравится. Проблем в том, что он не выполняет поставленные на него задачи. Вот это уже проблема.

Пример 2:
Вы владелец небольшой компании, занимающейся автоматизацией бизнес-процессов. Проблема — про вашу компанию мало что известно как среди потенциальных клиентов, так и среди профильных специалистов.

2) Поставить цель
Необходимо понять точную цель, которая должна быть достигнута.

Пример 1:
Закрыть доступ к социальным сетям? Нет. Цель — чтобы работа делалась во время.

Пример 2:
Один из ваших сотрудников должен выступить на профильной конференции с докладом.

3) Подготовить факты
Вместо своих личных оценочных суждений подготовить факты, с которыми трудно (или совсем невозможно) спорить. К суждению, а не факту, всегда можно задать вопрос «В чем это выражается?». Для факта этот вопрос звучит глупо.

Пример 1:
«Ты стал работать хуже.» — не факт. В чем это выражается? «Вот график. В последнее время ты зарываешь меньше часов разработки, чем раньше.» — факт.

Пример 2:
«О нас никто не знает.» — не факт. В чем это выражается? «За прошлый месяц мы получили всего 4 отклика соискателей на нашу вакансию.» — факт.

4) Запланировать подход
Прежде чем идти к человеку, необходимо понять, какие аргументы вы будете предъявлять и на что следует обратить внимание. Перед подбором аргументов, стоит также подумать, что движет этим человеком, какие у него мотивы, какие доводы будут наиболее эффективны. Для этого можно воспользоваться такими инструментами как:

Модель индивидуальных различий DISC: определяем тип личности по DISC, в зависимости от типа, подбираем необходимые аргументы.
Типология руководителей по И. Адизесу (модель PAEI): если вы собираетесь идти к своему руководителю, стоит понять, какой тип руководителя перед вами, какие ваши доводы он услышит с большей вероятностью.
 

Пример 1:
Сотрудник «сине-зеленый» по DISC, в этом случае, подойдут аргументы: «Посмотри на график, ты стал закрывать меньше часов разработки», «Твой показатель упал, а на тебя равняются другие», «Что случилось, давай разберем проблему вместе» и т. д.

Пример 2:
Сотрудник ярко-выраженная «желтая» личность по DISC. Для него подойдут такие доводы как: «Про тебя все узнают!», «У тебя появится много знакомых», «Твой авторитет в компании сильно вырастет» и т. д. 

Только точно определив цель и заранее подобрав аргументы, можно переходить к следующему шагу.

2. Проблема
algoritm-konstruktivnoj-konfrontacii-003

1) Озвучить проблему
Итак, проблема известна, вы встречаетесь с человеком, с которым эту проблему необходимо решить и озвучиваете ее. Не спешите сразу выплескивать все. Ведь все люди разные, и вы не можете знать, что у него в голове и под каким углом ему видится ситуация. Возьмите паузу, посмотрите как человек поведет себя, что сделает дальше. Пауза — это очень мощный прием.

Пример 1:
— Твои показатели упали в последнее время. Поделись, что случилось?

Пример 2:
— Хотел посоветоваться с тобой. О нас мало кто знает. Как ты думаешь, как бы нам раскрутить нашу организацию, сделать ее более известной?

2) Послушать точку зрения другой стороны
Это очень важный шаг! Может случиться так, что человек вообще не видит проблемы в данной ситуации, тогда вам пригодятся заранее подготовленные аргументы. А может быть, человек сам давно об этом думал, и лишний раз убеждать его нет никакого смысла.

Пример 1:
— Ничего не случилось вроде… Работаю как работаю…

Пример 2:
— Да, действительно, это важно. Я тоже думал об этом.

3) Получить согласие по проблеме
Это ключевой момент в алгоритме. Вы обязательно должны получить от человека согласие, что да, проблема имеет место быть! Если этого не сделать, если человек действительно сам не осознает в чем проблема или задача и почему ее необходимо решать, все дальнейшие шаги будут абсолютно бессмысленны. Может так случиться, что получить согласия по проблеме не удастся, несмотря на все ваши доводы и факты, в этом случае вы выходите из обсуждения со словами «Я, похоже, не могу донести проблему, давай поговорим позже». В этом нет ничего страшного. Подумайте и вернитесь к разговору чуть позже, с новыми фактами и аргументами. Может быть, и собеседник дозреет.

Пример 1:
— Да, правда, ситуация какая-то дурацкая…

Пример 2:
— Надо что-нибудь сделать в этом направлении!

Итак, подтверждение по проблеме получено, идем дальше.

3. Решение
algoritm-konstruktivnoj-konfrontacii-004

1) Попросить предложить решение
Когда вы донесли до человека суть проблемы, и он подтвердил, что действительно что-то необходимо изменить, велик соблазн сразу же выложить то решение, которое придумали вы. Так можно поступить, если вы беседуете со своим руководителем или заказчиком. В этом случае вы не создаете ему лишних проблем, а приходите сразу с конкретными предложениями. Если же вы решаете проблему со своим подчиненным, намного выгоднее сначала выслушать его предложения. Быть может он предложит лучший, или как раз тот самый вариант, который подготовили и вы. Но в этому случае, сотрудник примется реализовывать его с намного большим энтузиазмом, ведь это ЕГО план и он должен всем доказать, что он верен!

Пример 1:
— Ну я постараюсь более внимательно относиться к своим показателям. 

Пример 2: 
— А давай начнем вести корпоративный блог! Можно написать несколько профильных статей или что-то в этом роде. 

2) Рассмотреть варианты решения и выбрать один
Если же предложенный способ, по каким-то причинам вас не устраивает, не спешите критиковать его, лучше всего начать задавать наводящие вопросы. Утверждения включают в человеке желание поспорить. А что у человека включает мозг? Правильно, вопросы. Просто отвечая на вопросы, человек сам придет к выводу, что его решение не оптимально. И опять же, это будет уже его мнение, он будет чувствовать за него ответственность! Таким способом следует задавать вопросы до тех пор, пока сотрудник САМ не выработает такой стратегии решения задачи, которая удовлетворит и вас.

Пример 1:
— Просто задачи в последнее время какие-то скучные… 
— Без проблем! Скоро как-раз начнется новый проект. Хочешь поучаствовать?

Пример 2: 
— Еще можно записать обучающие видео…
— Отлично! Надо выбрать соответствующую площадку. Вот этот сайт сейчас очень популярен.
— Да, я сам его постоянно читаю. У них, кстати, скоро будет конференция, может выступить там?
— Хорошая идея! Ты смог бы это сделать?

3) Зафиксировать договоренность
Итак, проблема понятна, решение найдено, осталось только понять, кто и когда будет ее решать. В этом случае хорошо действует правило трех W: Who? What? When? (Кто? Что? Когда?). Вы, как человек, который ставит задачу, точно должны определить кто, что и в какие сроки должен сделать. Также необходимо убедиться, что все исполнители тоже точно это поняли.

Пример 1:
— Договорились, подтягивай свои показатели. Если с ними все будет ОК, я смогу убедить начальство перевести тебя на этот новый проект, который начнется осенью. Давай назначим следующую встречу на 1-ое сентября.

Пример 2: 
— Так, конференция через 2 месяца. Давай ты подумаешь о теме доклада. Я освобожу тебя от части задач, чтобы у тебя было время на подготовку. Встретимся в пятницу, посмотрим твои наработки.

Все задачи поставлены, сроки обговорены, далее необходим контроль.

4. Контроль
algoritm-konstruktivnoj-konfrontacii-005

1) Установить дату, чтобы обсудить прогресс
Как говаривал бывший генеральный директор IBM Лу Герстнер: «People do not do what you expect. They do what you inspect.» («Люди не делают то, что вы ожидаете. Они делают то, что вы проверяете.»). Поэтому очень важно назначить реперные точки — даты когда вы будете контролировать процесс решения задачи и объяснить что вы будете проверять. Например, если задача должна быть решена через месяц, то есть смысл раз в неделю-две интересоваться прогрессом выполнения. В этом случае вы сможете избежать ситуации, когда все будет делаться в последний момент.

Пример 1:
Сразу назначить в своем календаре и в календаре сотрудника встречу на 1-ое сентября, чтобы обговорить показатели.

Пример 2:
Зарегистрироваться на конференции. Назначить 3 встречи с интервалом в неделю: обсуждение темы, просмотр презентации и материалов, тестовый прогон выступления.

2) Проверить, достигнута ли цель?
Итак, вот долгожданный момент. Задача выполнена. Необходимо убедиться, что сделано именно то, что требовалось и в полном объеме.

Пример 1:
Сотрудник улучшил свои показатели. Время, проводимое в социальных сетях сильно сократилось.

Пример 2:
Выступление на конференции завершилось успешно. Посещаемость корпоративного сайта выросла. 

3) Проверить, что процесс работает
То, что поставленная задача выполнена, еще не означает, что изначальная проблема решена полностью. Может быть так, что в самом начале была не правильно определена цель, и проблема осталась.

Если, несмотря на все действия, цель не достигнута и проблема все равно не решена, необходимо тщательным образом проанализировать ситуацию и, как это не печально, вернуться к самому началу данного алгоритма.

Если же цель достигнута, то можно вздохнуть спокойно. Ура! Но и это не все. Обязательно необходимо похвалить (премировать, искренне признать заслуги) всех участников процесса. Это очень важно! В этом случае, люди с большим желанием возьмутся за следующую поставленную вами задачу.

Пример 1:
Похвалить сотрудника за хороший результат. Перевести его на новый проект.

Пример 2:
Публично поздравить сотрудника с успешным выступлением. Выложить видео на корпоративный сайт. Предложить продолжить выступать на конференциях и дальше.
        Контекст конфликта:
        {conflict.context}

        Участники конфликта (эмоции, поведение, реакции):
        {conflict.participants}

        Что уже предпринималось:
        {conflict.attempts}

        Цель: {conflict.goal}

        Структурируй ответ в HTML:
        - Определи DISC профили
        - Дай советы мне по взаимодействию со второй стороной конфликта
        - Важно чтобы мне как тому кто обратился к тебе как коучу за помощью стало понятно что мне делать, чтобы решить этот конфликт, отстояв свою точку зрения и цели
        - Предложи как с помощью конструктивного конфликта донести до второй стороны некоректность действия, предложи вариант даилога с этим человеком
        """

        client = get_openai_client()
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "Ты фасилитатор конфликтов и Agile-коуч."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
            max_tokens=4500
        )

        conflict.ai_analysis = response.choices[0].message.content
        db.session.commit()

        return jsonify({
            "id": conflict.id,
            "analysis": conflict.ai_analysis
        })

    except Exception as e:
        db.session.rollback()
        return jsonify({"error": str(e)}), 500
@bp_conflict.route("/conflicts", methods=["GET"])
@jwt_required()
def get_conflicts():
    user_id = get_jwt_identity()

    conflicts = Conflict.query.filter_by(user_id=user_id).order_by(Conflict.created_at.desc()).all()

    result = []
    for c in conflicts:
        result.append({
            "id": c.id,
            "context": c.context,
            "participants": c.participants,
            "attempts": c.attempts,
            "goal": c.goal,
            "status": c.status,
            "employee_1": {"id": c.employee_1.id, "name": c.employee_1.name} if c.employee_1 else None,
            "employee_2": {"id": c.employee_2.id, "name": c.employee_2.name} if c.employee_2 else None,
            "ai_analysis": c.ai_analysis,
            "created_at": c.created_at.isoformat()
        })
    return jsonify(result)

@bp_conflict.route("/conflict/<int:conflict_id>", methods=["DELETE"])
@jwt_required()
def delete_conflict(conflict_id):
    user_id = get_jwt_identity()

    conflict = Conflict.query.filter_by(id=conflict_id, user_id=user_id).first()
    if not conflict:
        return jsonify({"error": "Конфликт не найден"}), 404
    db.session.delete(conflict)
    db.session.commit()
    return jsonify({"message": "Удалено"})

@bp_conflict.route("/conflict/<int:conflict_id>", methods=["PUT"])
@jwt_required()
def update_conflict(conflict_id):
    user_id = get_jwt_identity()
    data = request.json
    conflict = Conflict.query.filter_by(id=conflict_id, user_id=user_id).first()
    if not conflict:
        return jsonify({"error": "Конфликт не найден"}), 404

    try:
        conflict.context = data.get("context", conflict.context)
        conflict.participants = data.get("participants", conflict.participants)
        conflict.attempts = data.get("attempts", conflict.attempts)
        conflict.goal = data.get("goal", conflict.goal)
        conflict.status = data.get("status", conflict.status)

        # Обновляем рекомендации от AI
        prompt = f"""
        Ты Agile-коуч, фасилитатор конфликтов. На основе следующих данных определи DISC-профили участников, и предложи стратегию разрешения конфликта по наиболее подходящей модели из списка:  Метод Конструктивная конфронтация как основной или "вин-вин" (выиграл-выиграл),Коучинговый подход, Медиация, Pine, Ненасильственное общение (ННО) по Маршаллу Розенбергу или лбые другие которые ты посчитаешь наиболее правильными но не оборачивай в markdown ```html:
Вот матераил что может помочь с ответом на запрос
Работа с личностями типа D: решайте конфликты напрямую
Личности типа D решительны, напористы и нацелены на результат. Хотя их сильная воля может пугать, особенно людей, не склонных к конфликтам, они ценят прямоту. При решении разногласий с личностью типа D не бойтесь быть прямолинейными. Они предпочитают решать конфликты напрямую, быстро их решать и двигаться вперед. Решая проблемы открыто и без колебаний, вы заслужите их уважение и, скорее всего, сможете эффективно достичь решения.

Совет: будьте настойчивы, уважительны и нацелены на решение. Избегайте хождения вокруг да около — переходите к сути.

2. Управление конфликтами с личностями типа «Я»: сохраняйте позитивный настрой
Личности типа I полны энтузиазма, общительны и процветают в позитивном взаимодействии. Однако они чувствительны к отвержению или негативу. При решении конфликта с личностью типа I важно поддерживать легкий и оптимистичный разговор. Начните обсуждение с комплимента или признания их сильных сторон. Дружелюбный тон обеспечит их вовлеченность и восприимчивость к обратной связи, в то время как резкий подход может привести к отстранению.

Совет: Подходите с позитивом и теплотой. Сбалансируйте конструктивную обратную связь с поощрением.

3. Разрешение конфликта с типами личности S: поиск точек соприкосновения
Личности типа S ценят гармонию, стабильность и сотрудничество. Они склонны избегать конфронтации и могут соглашаться на компромиссы, которые они на самом деле не поддерживают, чтобы сохранить мир. При решении конфликта с личностью типа S крайне важно подчеркнуть сотрудничество и взаимопонимание. Сосредоточьтесь на общих чертах, прежде чем углубляться в различия. Предложение решения, при котором обе стороны вносят коррективы, даст лучшие результаты, чем настойчивое требование радикальных изменений.

Совет: Подчеркните партнерство и сотрудничество. Представьте сбалансированный компромисс, чтобы способствовать сотрудничеству.

4. Разрешение конфликта с личностями типа C: сосредоточьтесь на фактах, а не на критике
Личности типа C аналитичны, ориентированы на детали и стремятся к точности. Поскольку они тратят так много времени на то, чтобы их работа была безупречной, они склонны воспринимать критику лично. При решении конфликтов с личностью типа C сосредоточьтесь на проблеме, а не на выявлении недостатков. Сформулируйте проблему с точки зрения объективных фактов или внешних факторов, которые они могли не учесть. Такой подход позволяет им рассматривать ситуацию более логично, не чувствуя себя лично атакованными.

Ту часть что находится ниже, можешь использовать если посчитаешь релевантным для ситуации в ином случае дай несолько других вариантов что можно сделать:
Конструктивная конфронтация: 1. Подготовка
algoritm-konstruktivnoj-konfrontacii-002

1) Определение проблемы
Итак, у нас имеется некоторая проблема или задача, которую необходимо решить со своим сотрудником, руководителем или заказчиком. Прежде всего необходимо точно определить суть проблемы. Иногда, это не так просто, как может показаться. Рассмотрим 2 типичных примера:

Пример 1:
Сотрудник все время сидит в социальной сети. В чем здесь проблема? В том, что он занимается посторонними вещами? Нет. Пусть сидит, если ему нравится. Проблем в том, что он не выполняет поставленные на него задачи. Вот это уже проблема.

Пример 2:
Вы владелец небольшой компании, занимающейся автоматизацией бизнес-процессов. Проблема — про вашу компанию мало что известно как среди потенциальных клиентов, так и среди профильных специалистов.

2) Поставить цель
Необходимо понять точную цель, которая должна быть достигнута.

Пример 1:
Закрыть доступ к социальным сетям? Нет. Цель — чтобы работа делалась во время.

Пример 2:
Один из ваших сотрудников должен выступить на профильной конференции с докладом.

3) Подготовить факты
Вместо своих личных оценочных суждений подготовить факты, с которыми трудно (или совсем невозможно) спорить. К суждению, а не факту, всегда можно задать вопрос «В чем это выражается?». Для факта этот вопрос звучит глупо.

Пример 1:
«Ты стал работать хуже.» — не факт. В чем это выражается? «Вот график. В последнее время ты зарываешь меньше часов разработки, чем раньше.» — факт.

Пример 2:
«О нас никто не знает.» — не факт. В чем это выражается? «За прошлый месяц мы получили всего 4 отклика соискателей на нашу вакансию.» — факт.

4) Запланировать подход
Прежде чем идти к человеку, необходимо понять, какие аргументы вы будете предъявлять и на что следует обратить внимание. Перед подбором аргументов, стоит также подумать, что движет этим человеком, какие у него мотивы, какие доводы будут наиболее эффективны. Для этого можно воспользоваться такими инструментами как:

Модель индивидуальных различий DISC: определяем тип личности по DISC, в зависимости от типа, подбираем необходимые аргументы.
Типология руководителей по И. Адизесу (модель PAEI): если вы собираетесь идти к своему руководителю, стоит понять, какой тип руководителя перед вами, какие ваши доводы он услышит с большей вероятностью.
 

Пример 1:
Сотрудник «сине-зеленый» по DISC, в этом случае, подойдут аргументы: «Посмотри на график, ты стал закрывать меньше часов разработки», «Твой показатель упал, а на тебя равняются другие», «Что случилось, давай разберем проблему вместе» и т. д.

Пример 2:
Сотрудник ярко-выраженная «желтая» личность по DISC. Для него подойдут такие доводы как: «Про тебя все узнают!», «У тебя появится много знакомых», «Твой авторитет в компании сильно вырастет» и т. д. 

Только точно определив цель и заранее подобрав аргументы, можно переходить к следующему шагу.

2. Проблема
algoritm-konstruktivnoj-konfrontacii-003

1) Озвучить проблему
Итак, проблема известна, вы встречаетесь с человеком, с которым эту проблему необходимо решить и озвучиваете ее. Не спешите сразу выплескивать все. Ведь все люди разные, и вы не можете знать, что у него в голове и под каким углом ему видится ситуация. Возьмите паузу, посмотрите как человек поведет себя, что сделает дальше. Пауза — это очень мощный прием.

Пример 1:
— Твои показатели упали в последнее время. Поделись, что случилось?

Пример 2:
— Хотел посоветоваться с тобой. О нас мало кто знает. Как ты думаешь, как бы нам раскрутить нашу организацию, сделать ее более известной?

2) Послушать точку зрения другой стороны
Это очень важный шаг! Может случиться так, что человек вообще не видит проблемы в данной ситуации, тогда вам пригодятся заранее подготовленные аргументы. А может быть, человек сам давно об этом думал, и лишний раз убеждать его нет никакого смысла.

Пример 1:
— Ничего не случилось вроде… Работаю как работаю…

Пример 2:
— Да, действительно, это важно. Я тоже думал об этом.

3) Получить согласие по проблеме
Это ключевой момент в алгоритме. Вы обязательно должны получить от человека согласие, что да, проблема имеет место быть! Если этого не сделать, если человек действительно сам не осознает в чем проблема или задача и почему ее необходимо решать, все дальнейшие шаги будут абсолютно бессмысленны. Может так случиться, что получить согласия по проблеме не удастся, несмотря на все ваши доводы и факты, в этом случае вы выходите из обсуждения со словами «Я, похоже, не могу донести проблему, давай поговорим позже». В этом нет ничего страшного. Подумайте и вернитесь к разговору чуть позже, с новыми фактами и аргументами. Может быть, и собеседник дозреет.

Пример 1:
— Да, правда, ситуация какая-то дурацкая…

Пример 2:
— Надо что-нибудь сделать в этом направлении!

Итак, подтверждение по проблеме получено, идем дальше.

3. Решение
algoritm-konstruktivnoj-konfrontacii-004

1) Попросить предложить решение
Когда вы донесли до человека суть проблемы, и он подтвердил, что действительно что-то необходимо изменить, велик соблазн сразу же выложить то решение, которое придумали вы. Так можно поступить, если вы беседуете со своим руководителем или заказчиком. В этом случае вы не создаете ему лишних проблем, а приходите сразу с конкретными предложениями. Если же вы решаете проблему со своим подчиненным, намного выгоднее сначала выслушать его предложения. Быть может он предложит лучший, или как раз тот самый вариант, который подготовили и вы. Но в этому случае, сотрудник примется реализовывать его с намного большим энтузиазмом, ведь это ЕГО план и он должен всем доказать, что он верен!

Пример 1:
— Ну я постараюсь более внимательно относиться к своим показателям. 

Пример 2: 
— А давай начнем вести корпоративный блог! Можно написать несколько профильных статей или что-то в этом роде. 

2) Рассмотреть варианты решения и выбрать один
Если же предложенный способ, по каким-то причинам вас не устраивает, не спешите критиковать его, лучше всего начать задавать наводящие вопросы. Утверждения включают в человеке желание поспорить. А что у человека включает мозг? Правильно, вопросы. Просто отвечая на вопросы, человек сам придет к выводу, что его решение не оптимально. И опять же, это будет уже его мнение, он будет чувствовать за него ответственность! Таким способом следует задавать вопросы до тех пор, пока сотрудник САМ не выработает такой стратегии решения задачи, которая удовлетворит и вас.

Пример 1:
— Просто задачи в последнее время какие-то скучные… 
— Без проблем! Скоро как-раз начнется новый проект. Хочешь поучаствовать?

Пример 2: 
— Еще можно записать обучающие видео…
— Отлично! Надо выбрать соответствующую площадку. Вот этот сайт сейчас очень популярен.
— Да, я сам его постоянно читаю. У них, кстати, скоро будет конференция, может выступить там?
— Хорошая идея! Ты смог бы это сделать?

3) Зафиксировать договоренность
Итак, проблема понятна, решение найдено, осталось только понять, кто и когда будет ее решать. В этом случае хорошо действует правило трех W: Who? What? When? (Кто? Что? Когда?). Вы, как человек, который ставит задачу, точно должны определить кто, что и в какие сроки должен сделать. Также необходимо убедиться, что все исполнители тоже точно это поняли.

Пример 1:
— Договорились, подтягивай свои показатели. Если с ними все будет ОК, я смогу убедить начальство перевести тебя на этот новый проект, который начнется осенью. Давай назначим следующую встречу на 1-ое сентября.

Пример 2: 
— Так, конференция через 2 месяца. Давай ты подумаешь о теме доклада. Я освобожу тебя от части задач, чтобы у тебя было время на подготовку. Встретимся в пятницу, посмотрим твои наработки.

Все задачи поставлены, сроки обговорены, далее необходим контроль.

4. Контроль
algoritm-konstruktivnoj-konfrontacii-005

1) Установить дату, чтобы обсудить прогресс
Как говаривал бывший генеральный директор IBM Лу Герстнер: «People do not do what you expect. They do what you inspect.» («Люди не делают то, что вы ожидаете. Они делают то, что вы проверяете.»). Поэтому очень важно назначить реперные точки — даты когда вы будете контролировать процесс решения задачи и объяснить что вы будете проверять. Например, если задача должна быть решена через месяц, то есть смысл раз в неделю-две интересоваться прогрессом выполнения. В этом случае вы сможете избежать ситуации, когда все будет делаться в последний момент.

Пример 1:
Сразу назначить в своем календаре и в календаре сотрудника встречу на 1-ое сентября, чтобы обговорить показатели.

Пример 2:
Зарегистрироваться на конференции. Назначить 3 встречи с интервалом в неделю: обсуждение темы, просмотр презентации и материалов, тестовый прогон выступления.

2) Проверить, достигнута ли цель?
Итак, вот долгожданный момент. Задача выполнена. Необходимо убедиться, что сделано именно то, что требовалось и в полном объеме.

Пример 1:
Сотрудник улучшил свои показатели. Время, проводимое в социальных сетях сильно сократилось.

Пример 2:
Выступление на конференции завершилось успешно. Посещаемость корпоративного сайта выросла. 

3) Проверить, что процесс работает
То, что поставленная задача выполнена, еще не означает, что изначальная проблема решена полностью. Может быть так, что в самом начале была не правильно определена цель, и проблема осталась.

Если, несмотря на все действия, цель не достигнута и проблема все равно не решена, необходимо тщательным образом проанализировать ситуацию и, как это не печально, вернуться к самому началу данного алгоритма.

Если же цель достигнута, то можно вздохнуть спокойно. Ура! Но и это не все. Обязательно необходимо похвалить (премировать, искренне признать заслуги) всех участников процесса. Это очень важно! В этом случае, люди с большим желанием возьмутся за следующую поставленную вами задачу.

Пример 1:
Похвалить сотрудника за хороший результат. Перевести его на новый проект.

Пример 2:
Публично поздравить сотрудника с успешным выступлением. Выложить видео на корпоративный сайт. Предложить продолжить выступать на конференциях и дальше.

Совет: будьте ясны, основывайтесь на фактах и ​​избегайте личной критики. Признайте их тяжелую работу, представляя любые упущенные переменные. 
        Контекст конфликта:
        {conflict.context}

        Участники конфликта (эмоции, поведение, реакции):
        {conflict.participants}

        Что уже предпринималось:
        {conflict.attempts}

        Цель: {conflict.goal}

        Структурируй ответ в HTML:
        - Определи DISC профили
        - Дай советы мне по взаимодействию со второй стороной конфликта
        - Важно чтобы мне как тому кто обратился к тебе как коучу за помощью стало понятно что мне делать, чтобы решить этот конфликт, отстояв свою точку зрения и цели
        - Предложи как с помощью конструктивного конфликта донести до второй стороны некорректность действия, предложи вариант диалога с этим человеком
        """

        client = get_openai_client()
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "Ты фасилитатор конфликтов и Agile-коуч."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
            max_tokens=4500
        )

        conflict.ai_analysis = response.choices[0].message.content
        db.session.commit()

        return jsonify({
            "id": conflict.id,
            "analysis": conflict.ai_analysis
        })

    except Exception as e:
        db.session.rollback()
        return jsonify({"error": str(e)}), 500

@bp_conflict.route("/conflicts/save", methods=["POST"])
@jwt_required()
def save_conflict():
    data = request.json
    user_id = get_jwt_identity()

    conflict_id = data.get("id")
    conflict = Conflict.query.filter_by(id=conflict_id, user_id=user_id).first()

    if not conflict_id:
        return jsonify({"error": "ID конфликта не указан"}), 400

    conflict = Conflict.query.get(conflict_id)
    if not conflict:
        return jsonify({"error": "Конфликт не найден"}), 404

    try:
        conflict.context = data.get("context", conflict.context)
        conflict.participants = data.get("participants", conflict.participants)
        conflict.attempts = data.get("attempts", conflict.attempts)
        conflict.goal = data.get("goal", conflict.goal)
        conflict.status = data.get("status", conflict.status)

        db.session.commit()

        return jsonify({"message": "Конфликт обновлён"})
    except Exception as e:
        db.session.rollback()
        return jsonify({"error": str(e)}), 500
